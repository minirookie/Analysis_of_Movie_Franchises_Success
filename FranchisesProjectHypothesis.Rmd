---
title: "Movie Franchises Analysis"
author: "Shanshan Bradford"
output:
  word_document: default
  pdf_document: default
fontsize: 10pt
---

```{r section 1, include = TRUE, error=TRUE, fig.dim=c(2, 0.5)}
# The 3rd hypothesis: The movie franchises are the rising money makers, 
# and it is important to the profitability of the movie business.

rm(list = ls())
working.path = "/Users/syu/Library/CloudStorage/OneDrive-St.JudeChildren'sResearchHospital/UDrive/Documents_syu_Backup/Github_deposit/MoviesFranchises"
setwd(working.path)

#read two data files and order data sets in an invert chronological order
movie.meta = read.csv("movie_metadata_cleaned.csv", header = T, sep = ",", 
                      as.is = T, na.strings = c(""))
movie.meta = movie.meta[order(movie.meta$title_year, decreasing = T), ]

movfran.fina = read.csv("MovieFranchise_FinanceInfo.csv", header = T, sep = ",",
                        as.is = T, na.strings = c("", "NA"))
movfran.fina = movfran.fina[order(movfran.fina$Franchise, decreasing = T), ]

# the year and gross profit data will be needed 
# remove the null value of title year and gross revenue
movie.gross = as.numeric(as.character(movie.meta$gross))

# check how many records will be removed
length(movie.gross[is.na(movie.gross)])

movie.meta.clean = movie.meta[!is.na(movie.gross),] # remove records of no gross revenue

movie.year = as.character(as.factor(movie.meta.clean$title_year))
movie.year[is.na(movie.year)] # check how many records will be removed
movie.meta.clean = movie.meta.clean[!is.na(movie.year),]# remove records of no title_year
dim(movie.meta.clean)


## Clean error in several text content variables that will be used for regression analysis 
unique(movie.meta.clean$color) # color variable has unnecessary space
movie.meta.clean$color = gsub("^ +", "", movie.meta.clean$color)

# content_rating variable mixed old and new rating system
# replace the old rating records with current USA rating system 
unique(movie.meta.clean$content_rating)
table(movie.meta.clean$content_rating)

# If a film has not been submitted for a rating or is an uncut version, 
# the labels Not Rated (NR) or Unrated (UR) are often used
movie.meta.clean$content_rating = gsub("Not Rated", "Unrated", movie.meta.clean$content_rating)

# rating "Approved" is only for Pre-1968 titles, should be equal to "Passed"
# films were approved or disapproved simply based on whether they were deemed 'moral' or 'immoral'
movie.meta.clean$content_rating = gsub("Passed", "Approved", movie.meta.clean$content_rating)

# "M" was renamed to "GP" in 1970
movie.meta.clean$content_rating = gsub("M", "GP", movie.meta.clean$content_rating)
# in 1972, "GP" was revised to "PG"
movie.meta.clean$content_rating = gsub("GP", "PG", movie.meta.clean$content_rating)
# in 1990, "X" replaced by "NC-17"
movie.meta.clean$content_rating = gsub("X", "NC-17", movie.meta.clean$content_rating)

#########################################################################
# adjust the inflation ratio with CPI data
#########################################################################

# Before adjustment, change the datatype of gross revenue and title year
movie.meta.clean$movie.gross = as.numeric(as.character(movie.meta.clean$gross))
movie.meta.clean$movie.year = as.character(as.factor(movie.meta.clean$title_year))
# Then, remove data of unnecessary data types
movie.meta.clean$gross = NULL
movie.meta.clean$title_year = NULL


# Then, extract gross profit and year information in two vectors
# get ready for inflation adjustment
new.movie.gross = movie.meta.clean$movie.gross
# year information is treated as numeric here to ease the inflation adjustment
new.movie.year = as.numeric(movie.meta.clean$movie.year)

range(new.movie.year) # this data set almost has a century of movie information

# load in historical inflation data
cpi.infla.hist = read.csv("CPIHistoricInflationData.csv", header = T,
                          sep = ",", as.is = T, na.strings = "NA")
# check out the variables and subset the historical inflation data to 2016
colnames(cpi.infla.hist)
cpi.infla = cpi.infla.hist[-1, c("X", "Year", "Ave.")]
colnames(cpi.infla) = c("X", "Year", "Ave")

# reassign new row names and index number
row.names(cpi.infla) <- 1:104
cpi.infla$X <- 1:104
head(cpi.infla) # check whether the cpi.infla is updated after change
str(cpi.infla) # check the data type to match the data from two other data sets

# To simplify the code, extract year and annual inflation rate to two vectors
cpi.ave = cpi.infla$Ave
cpi.year = cpi.infla$Year

# calculate how much of the past profit would worth in 2016
# use the year of each movie to find the corresponding inflation ratio
# then multiply the inflation ratio to the recorded gross profit
adjust.gross <- sapply(1:length(new.movie.gross), simplify = T,
  function(i)
  {new.movie.gross[i] * cpi.ave[1]/cpi.ave[grep(new.movie.year[i], cpi.year)]})

# add back the inflation adjusted gross back to the cleaned data set
movie.meta.clean$adjust.gross = adjust.gross
######################################################################################

# Clean text content in names and franchise title 
# Replace non graphical character and punctuation with one space each
movie.names = gsub("[^[:graph:]]", " ", movie.meta.clean$movie_title)
movie.names = gsub("[[:punct:]]{1,20}", " ", movie.names)
Fran.title = gsub("[^[:graph:]]", " ", movfran.fina$Franchise)
Fran.title = gsub("[[:punct:]]{1,20}", " ", Fran.title)

# Replace tab and extra space introduced early with one space
movie.names = gsub("[ |\t]{2,}", " ", movie.names)
movie.names = gsub("\\s+", " ", movie.names)
Fran.title = gsub("[ |\t]{2,}", " ", Fran.title)
Fran.title = gsub("\\s+", " ", Fran.title)

# Remove extra blank space at the beginning and the end
movie.names = gsub("^ +", "", movie.names) 
movie.names = gsub(" $+", "", movie.names)
Fran.title = gsub("^ +", " ", Fran.title)
Fran.title = gsub(" $+", " ", Fran.title)

# add cleaned title and names back to the data frames loaded from csv files
movie.meta.clean$movie.names.clean = movie.names
movfran.fina$fran.title.clean = Fran.title

# find whether there are franchise titles were recorded more than once
which(table(Fran.title) >1) # expected result is none

#change names to lower cases for further analysis
movie.names = tolower(movie.names)
Fran.title = tolower(Fran.title)

# use franchise names to find the franchise movie names
fran.mov.list = sapply(1:length(Fran.title), simplify = T,
            function(i){grep(Fran.title[i], movie.names, ignore.case = T)})

fran.movname.list = sapply(1:length(Fran.title), simplify = T,
  function(i){grep(Fran.title[i], movie.names, ignore.case = T, value = T)})


# check franchise title with numeric title cause mismatches
fran.movname.list[c(751:760)] # it looks like franchise 300 grab other movies
fran.mov.list[[751]] # the wrong movie numbers are 2235 and 2746

# unlist the franchise movie
fran.mov.index = unlist(fran.mov.list, recursive = T)
two.wrongmov = c(grep("2235", fran.mov.index), grep("2746", fran.mov.index))

# check whether wrong movies is removed
length(fran.mov.index) -length(fran.mov.index[-two.wrongmov]) 
fran.mov.index = fran.mov.index[-two.wrongmov]

# create a subset data of franchise movies and non franchise movies
fran.movie = movie.meta.clean[fran.mov.index,]
other.movie = movie.meta.clean[-fran.mov.index,]
other.movie.nogross = movie.meta[-fran.mov.index,]
write.csv(fran.movie, file = "FranchiseMovieDetails.csv", eol = "\r\n")

fran.movie$movie_title = NULL #remove original (pre-cleaned) movie title 
other.movie$movie_title = NULL #remove original (pre-cleaned) movie title

# compare these two subsets length and visualize the comparison
movieNo.compare = c(length(row.names(fran.movie)),
  length(row.names(other.movie)), length(row.names(other.movie.nogross)))

#generate an image file
png("barplot_MovieNumberComparison.png")
par(mar=c(5, 0, 0, 0))
bargra1 = barplot(movieNo.compare, horiz = T, 
        col = c("purple", "orange","gray"), beside = FALSE, space = 0.1, 
        width = c(0.05, 0.05, 0.05)) 
title(main = "Total movie number of non franchises and franchises", 
      cex.main = 1.25, line = 1, adj = 0.5) 
text(bargra1, adj = c(0, NA), cex = 1.5,
     labels = c("Franchise movies", "Non franchise movies with gross profit data", 
                "All non franchise movies") )
#save the image plot
dev.off()

# knit the generated image file into the report
knitr::include_graphics(paste(working.path, "barplot_MovieNumberComparison.png", sep = "/"))

names(movieNo.compare) = c("Franchise movies",
                           "Non franchise movies with gross profit data", 
                           "All non franchise movies") 
movieNo.compare

#calculate the total and mean profit of two types of movies
avgprof.fran = mean(fran.movie$movie.gross, na.rm = T)
avgprof.other = mean(other.movie$movie.gross, na.rm = T)

gross.compare = c(sum(fran.movie$movie.gross, na.rm = T), 
                  sum(other.movie$movie.gross, na.rm = T))

png("barplot_ProfitSumComparison.png")
par(mar=c(5, 0, 0, 0))
bargra2 = barplot(gross.compare, horiz = T,
        col = c("purple", "orange"), beside = FALSE, las = 1,  
        space = 0.1, width = c(0.05, 0.05))
title(main = "Gross profit sum (in dollars) of non franchises and franchises", 
      cex.main = 1.25, line = 1, adj = 0.5)
text(bargra2, adj = c(0, NA), cex = 1.5,
     labels = c("Franchise movies", "Non Franchise movies") )
dev.off()
knitr::include_graphics(paste(working.path, "barplot_ProfitSumComparison.png", sep = "/"))

names(gross.compare) = c("Franchise movies", "Non Franchise movies")
gross.compare

png("barplot_AvgfitComparison.png")
par(mar=c(5, 0, 0, 0))
bargra3 =barplot(c(avgprof.fran, avgprof.other), horiz = T, 
        col = c("purple", "orange"), beside = FALSE, space = 0.1,
        width = c(0.05, 0.05), xlim = c(0, 1e+08), cex.axis = 0.95)
title(main = "Average gross profit (gross profit per movie) in dollars", 
      cex.main = 1.25, line = 1, adj = 0.5)
text(bargra3, adj = c(0, NA), cex = 1.5,
     labels = c("Franchise movies", "Non Franchise movies"))
dev.off()
knitr::include_graphics(paste(working.path, "barplot_AvgfitComparison.png", sep = "/"))
                         
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r section 2, include = TRUE,error=TRUE}
#############################################################################
#              K-means clustering and linear regression modeling            #
#############################################################################

#############################################################################
#      K-means clustering, to explore the franchise movie financial data    #
#############################################################################

# Check the datatype of the franchise finance data
str(movfran.fina) # all the box office records are character because of the "$"

# replace the dollar sign, comma, and extra space of box office records
# coerce the data to numeric data type after clean the number records
infl.adj.dobo = gsub("\\$", "", movfran.fina$Infl..Adj..Dom..Box.Office)
infl.adj.dobo = gsub(",", "", infl.adj.dobo)
infl.adj.dobo = gsub("^ +", "", infl.adj.dobo)
infl.adj.dobo = gsub(" $+", "", infl.adj.dobo)
infl.adj.dobo = as.numeric(infl.adj.dobo)

world.dobo = gsub("\\$", "", movfran.fina$Worldwide.Box.Office)
world.dobo = gsub(",", "", world.dobo)
world.dobo = gsub("^ +", "", world.dobo)
world.dobo = gsub(" $+", "", world.dobo)
world.dobo = as.numeric(world.dobo)

do.bo = gsub("\\$", "", movfran.fina$Domestic.Box.Office)
do.bo = gsub(",", "", do.bo)
do.bo = gsub("^ +", "", do.bo)
do.bo = gsub(" $+", "", do.bo)
do.bo = as.numeric(do.bo)

# add new numeric data type to the data frame movfan.fina
movfran.fina$infl.adj.dom.boxoffice = infl.adj.dobo
movfran.fina$glob.boxoffice = world.dobo
movfran.fina$dome.boxoffice = do.bo
movfran.fina$other.boxoffice = world.dobo - do.bo

# replace the old character box office record with the NULL
movfran.fina$Infl..Adj..Dom..Box.Office = NULL
movfran.fina$Worldwide.Box.Office = NULL
movfran.fina$Domestic.Box.Office = NULL
# change the long variable names to short ones
names(movfran.fina) = c("X", "Franchise", "tot.movies", "First.Year", "Last.Year", 
                        "tot.years","fran.title.clean", "infl.adj.dom.boxoffice", 
                        "glob.boxoffice","dome.boxoffice", "other.boxoffice")

# Then, check whether and where NA value in the franchise movie data are 
which(is.na(movfran.fina[, -c(2,7)]) == T, arr.ind = T)[1:30,] # all NA in No.of.Years 

# Find out row numbers/index for NA value in franchise financial data
franyear.nv = which(is.na(movfran.fina$tot.years) == T)
length(franyear.nv)

# All these NA value movies have the same "First.Year" and "Last.Year" 
identical(movfran.fina$First.Year[franyear.nv], movfran.fina$Last.Year[franyear.nv])
# This means these movie franchise were in theater for a year

# majority of movie franchises of one in-theater year have only one movie
table(movfran.fina[franyear.nv, ]$tot.movies)
# Given most popular movies running in theaters less than one year, 
# the in-theater year info for franchises of one movie is probably left censored
# Possibly it is one reason that these data is missing (measurement unit is year)

# subset the franchises of one movie that is left censored
franyear.left = which(movfran.fina[franyear.nv,]$tot.movies > 1)
# use R code movfran.fina[franyear.nv[franyear.left],1:5] to make sure index vectors are right
# and knit the data with a table format
knitr::kable(head(movfran.fina[franyear.nv[franyear.left],2:6], 30), "simple") 


# Replace the tot.year NA value with 0.5 to the left censored data
# Use 0.5 year (6 months) as an estimated average of movie running time 
movfran.fina[franyear.nv[-franyear.left],]$tot.years = 0.5
# Use 1 year for franchises having more than one movie but only lasting for a year
movfran.fina[franyear.nv[franyear.left],]$tot.years = 1

# remove the text data out of franchise financial data for k-means clustering
str(movfran.fina[, -c(1,2,7,9,10)]) # check the data; use inflation adjusted domestic data

# search optimal k with elbow plot for k-means clustering
library(cluster)
library(ggplot2)

set.seed(12345)
k.max = 14
total.wss = sapply(2:k.max, simplify = T,
                  function(k){ kmeans(movfran.fina[, -c(1,2,7,9,10)], k, nstart = 50, 
                                     iter.max = 100)$tot.withinss })

between.ss = sapply(2:k.max, simplify = T,
                 function(k){ kmeans(movfran.fina[, -c(1,2,7,9,10)], k, nstart = 50,
                                    iter.max = 100)$betweenss })

total.wss/between.ss

png("plot_KmeansElbow.png")
par(mar=c(5, 0, 0, 0))
plot(2:k.max, total.wss/between.ss, type = "b", pch = 19, col = rainbow(c(k.max - 1)), 
     frame.plot = F, lwd = 2, cex.lab = 1.25, cex.axis = 1.25,
     xlim = c(2,14), ylim = c(0,0.8))
title(main = "K-means clustering performed on franchise finacial data", adj = 0.5, 
      line = 0.5)
text(2:k.max, total.wss/between.ss, labels = 2:k.max, cex = 1.1, adj = c(1.5, -0.2))
abline(v = 4, lwd = 4, lty = 3, col = "blue")
dev.off()
knitr::include_graphics(paste(working.path, "plot_KmeansElbow.png", sep = "/"))

# set k = 4 for k-means
set.seed(12345)
kcluster.movfran = kmeans(movfran.fina[, -c(1,2,7,9,10)], 4, nstart = 50,iter.max = 100)

# add the clusters to the movie franchise financial data
movfran.fina$K.cluster = kcluster.movfran$cluster
# select the variables needed for result discussion and further analysis
colnames(movfran.fina)
movfran.result = cbind(movfran.fina[, c(1,7,12)], movfran.fina[, c(8,11)], 
                       movfran.fina[,c(3,6)], movfran.fina[,c(4,5)])

#organize the result by k-means clusters
movfran.result = movfran.result[order(movfran.result$K.cluster, decreasing = F), ]
per.kcluster = prop.table(table(movfran.result$K.cluster))
per.kcluster = round(per.kcluster*100, 2)
per.kcluster = paste(per.kcluster, "%", sep = "")
kluster.label = paste(c("1","2","3","4"), " ", "(", per.kcluster, ")", sep = "")

png("pie_K-clusterComposition.png")
par(mar = c(4,1,1,1))
kcluster.pie = pie(table(movfran.result$K.cluster), clockwise = F, 
                  labels = kluster.label, cex.main = 1.4, line = -1.25,
                  main = "Composition of franchise movie clusters ",
                  col = c("salmon", "yellow green", "dark cyan","purple"))
dev.off()
knitr::include_graphics(paste(working.path, "pie_K-clusterComposition.png", sep = "/"),
                         auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))

# list movie names in clusters 1, 3, and 4
movfran.result[movfran.result$K.cluster == 3,]$fran.title.clean
movfran.result[movfran.result$K.cluster == 4,]$fran.title.clean[1:50]
movfran.result[movfran.result$K.cluster == 1,]$fran.title.clean

# use following codes to show clusters results, and knit them into tables
# movfran.result[movfran.result$K.cluster == 3, -1]
knitr::kable(movfran.result[movfran.result$K.cluster == 3, 2:6], "simple")
# movfran.result[movfran.result$K.cluster == 4, -1][1:30,]
knitr::kable(head(movfran.result[movfran.result$K.cluster == 4, 2:6], 20), "simple")
# movfran.result[movfran.result$K.cluster == 1, -1]
knitr::kable(head(movfran.result[movfran.result$K.cluster == 1, 2:6], 20), "simple")

# create side by side visualization for comparison
library(reshape2) # to create with ggplot2, need melt of reshape2 to remold data
library(plyr)

# subset the result data needed to be melted
plot1.subset = movfran.result[, c(3:4, 6:7, 9)]

# choose ID variables from the subset that are not going to be melted 
# facet_wrap will use these ID to create graph panel(layout)
plot1.id1 = names(movfran.result)[3:4]
plot1.subset = melt(plot1.subset, id = plot1.id1)
plot1.subset$variable = gsub("tot.movies", "Total movie numbers", plot1.subset$variable)
plot1.subset$variable = gsub("tot.years", "Total years", plot1.subset$variable)
plot1.subset$variable = gsub("Last.Year", "The most recent year", plot1.subset$variable)

str(plot1.subset) # check the data types of the melted subset

# This panel will plot the relationship between tot.movies, tot.years, Last.years
# and inflation adjusted domestic box office record

png("ggplot_KmeansAnalysis.png")
ggplot(plot1.subset, aes(value, infl.adj.dom.boxoffice, 
      col = as.factor(plot1.subset$K.cluster))) + 
      geom_point(shape = 16, size = 2) + 
      facet_wrap( ~ variable, nrow = 1, ncol = 3, scales = "free_x") +
      theme(legend.position = "bottom", 
      legend.text = element_text(size = 16),
      plot.title = element_text(size = rel(1.75), hjust = 0.5, vjust=0),
      axis.title.y = element_text(size = rel(1.5), angle = 90),
      axis.title.x = element_text(size = rel(1.5), angle = 0)) + 
      labs(title = "k-means cluster analysis",  par(adj = 1)) + 
      ylab("Inflation adjusted domestic box office (in dollar)") + 
            guides(color = guide_legend(title = "K clusters", 
                   title.theme = element_text(size = 16, 
                   colour = "black", face = "plain", angle = 0)))
dev.off()
knitr::include_graphics(paste(working.path, "ggplot_KmeansAnalysis.png", sep = "/"),
                         auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))


png("ggplot_FranchiseGlobalBox.png")
ggplot(movfran.result, aes(movfran.result$infl.adj.dom.boxoffice,
                           movfran.result$other.boxoffice, 
                           col = as.factor(movfran.result$K.cluster))) + 
        geom_point(shape = 19, size = 2) + 
        theme(legend.position="bottom",
              legend.text = element_text(size = 16),
              plot.title = element_text(size = rel(1.75), hjust = 0.5, vjust = 0),
              axis.title.y = element_text(size = rel(1.5), angle = 90),
              axis.title.x = element_text(size = rel(1.5), angle = 0)) +
        labs(title = "Franchise movie global box office",  par(adj = 1)) +
        xlab("Inflation adjusted domestic box office (in dollar)") +
        ylab("Other country box office (in dollar)") +
        guides(color = guide_legend(title = "K clusters", 
              title.theme = element_text(size = 16, 
              colour = "black", face = "plain", angle = 0)))
dev.off()
knitr::include_graphics(paste(working.path, "ggplot_FranchiseGlobalBox.png", sep = "/"),
                         auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))


# Visualize the individual graphs
ggplot(movfran.result, aes(movfran.result$tot.years, 
                           movfran.result$infl.adj.dom.boxoffice, 
                           col = as.factor(movfran.result$K.cluster))) + 
  geom_point(shape = 19, size = 2) + 
  ylab("Inflation adjusted domestic box office") + 
  xlab("Total years") + 
  theme(legend.position="top") +
  guides(color = guide_legend(title = "K clusters" ))

ggplot(movfran.result, aes(movfran.result$tot.movies, 
                           movfran.result$infl.adj.dom.boxoffice, 
                           col = as.factor(movfran.result$K.cluster))) + 
  geom_point(shape = 19, size = 2) + 
  ylab("Inflation adjusted domestic box office") + 
  xlab("Total movies") + 
  theme(legend.position="top") +
  guides(color = guide_legend(title = "K clusters" ))

ggplot(movfran.result, aes(movfran.result$Last.Year, 
                           movfran.result$infl.adj.dom.boxoffice, 
                           col = as.factor(movfran.result$K.cluster))) + 
  geom_point(shape = 19, size = 2) + 
  ylab("Inflation adjusted domestic box office") + 
  xlab("Last years") + 
  theme(legend.position="top") +
  guides(color = guide_legend(title = "K clusters" ))

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r section 3, include = TRUE, error=TRUE}
options(width = 350)
##############################################################################
#              Regression modeling, to explore movie meta data               #
##############################################################################

## Check and remove NA values left the cleaned movie meta data set
# check all column names, leave out text-content variables to examine NA values
names(movie.meta.clean) # check all column names

# further subset the cleaned data set for regression
# leave out repeat and unnecessary variables
movie.regrset= movie.meta.clean[, -c(11,27)]

# display the col names for movie.regrset
names(movie.regrset)
# create an index vector for character type columns of movie.regrset
chrcol.index = c(1:2,7,9:10,13,15:16,18:20,26,28) # movie year should be character data
str(movie.regrset[, chrcol.index]) # check whether the index vector is correct
str(movie.regrset[, -chrcol.index])

# create column length vectors for both subsets of character or numeric data
chr.col.length = length(colnames(movie.regrset[, chrcol.index]))
num.col.length = length(colnames(movie.regrset[, -chrcol.index]))

# coerce data types back and forward to change character "NA" to Null value
movie.regrset.chrcol = sapply(1:chr.col.length, simplify = T, function(j){
  as.character(as.factor(movie.regrset[, chrcol.index][,j]))})

movie.regrset.numcol = sapply(1:num.col.length, simplify = T, function(i){
  as.numeric(as.character(movie.regrset[, -chrcol.index][,i]))})

# check out new generated subsets: matrixs
head(movie.regrset.chrcol,2)
head(movie.regrset.numcol,2) 

# add column names to matrixs
colnames(movie.regrset.chrcol) = colnames(movie.regrset[, chrcol.index])
colnames(movie.regrset.numcol) = colnames(movie.regrset[, -chrcol.index])

# switch the cleaned movie names to the left first column and fix the column name
movie.regrset.chrcol = cbind(movie.regrset.chrcol[, "movie.names.clean"],
                             movie.regrset.chrcol[, c(1:chr.col.length-1)])
colnames(movie.regrset.chrcol)[1] = "movie.names.clean"

# change the matrixs to data frame and combine two data frames
movie.regrset.numcol = data.frame(movie.regrset.numcol, stringsAsFactors = F)
movie.regrset.chrcol = data.frame(movie.regrset.chrcol, stringsAsFactors = T)
movie.regrset = cbind(movie.regrset.chrcol, movie.regrset.numcol)

# check out the column names again and choose column for regression
colnames(movie.regrset)

# For regression model, keep movie names as ID
# use numeric data +/- character data of color, language, country, content rating, year
movie.regr.01 = movie.regrset[, c(1,14:28)]
movie.regr.02 = movie.regrset[, c(1:2,10:13,14:28)] 


# create matrix of NA value indices
# use non-repeat row number of the matrix to remove records with NA value
narec.regr01 = which(is.na(movie.regr.01) == T, arr.ind = T)
movie.regr.01 = movie.regr.01[-unique(narec.regr01[, "row"]), ]
narec.regr02 = which(is.na(movie.regr.02) == T, arr.ind = T)
movie.regr.02 = movie.regr.02[-unique(narec.regr02[, "row"]), ]

# 31 records that NA values are only in the text-content variables
dim(movie.regr.01)[1] - dim(movie.regr.02)[1] 

# regression modeling
library("stats")
#create length variables for training data sets
set.seed(3456)
train.length.01 = floor(0.7*dim(movie.regr.01)[1])
train.length.02 = floor(0.7*dim(movie.regr.02)[1])

# generate random index with sample function to create training and test data sets
# exclude the movie names for both training and test data sets
train.ind.01 = sample(1:dim(movie.regr.01)[1], train.length.01)
train.reg.01 = movie.regr.01[train.ind.01, -1]
test.reg.01 = movie.regr.01[-train.ind.01, -1]

train.ind.02 = sample(1:dim(movie.regr.02)[1], train.length.02)
train.reg.02 = movie.regr.02[train.ind.02, -1]
test.reg.02 = movie.regr.02[-train.ind.02, -1]

#create a vector for storing the original value of adjust.gross variable
#adjust.gross is a dependent variable
adjgross.testreg01 = test.reg.01$adjust.gross
adjgross.testreg02 = test.reg.02$adjust.gross

#Then removed the existing variables for prediction
test.reg.01$adjust.gross = NULL
test.reg.02$adjust.gross = NULL

# run logistic model to the subset with only numeric variables only 
# adjust.gross is the dependent variable
# "." means include everything except the dependent variable
rgmodel.01 = glm(adjust.gross ~ ., family = gaussian, data = train.reg.01)
summary.glm(rgmodel.01)
names(train.reg.01)

# Observation to model 01
# imdb_score appear to be insignificant
# num_user_for_reviews and num_critic_for_reviews appear to be less significant

# remove imdb_score and num_user_for_reviews 
rgmodel.01mo = glm(adjust.gross ~ ., family = gaussian, data = train.reg.01[,-c(1,9,12)])
summary.glm(rgmodel.01mo)

#predict response variable, the predicted values are probabilities
pred.reg.01 <- predict(rgmodel.01mo, newdata = test.reg.01[,-c(1,9,12)], type = "response")


# run logistic model to the subset of combined numeric & several categorical variables
rgmodel.02 = glm(adjust.gross ~ ., family = gaussian, data = train.reg.02)
# create an index of sorted Estimate/P-value, to list important variables on top
rgmodel.02.PvalueSort = order(summary.glm(rgmodel.02)[12]$coefficients[,4], decreasing = FALSE)

#list logistic linear regression modeling statistics
summary.glm(rgmodel.02)[c(1,3:4)]
rgmodel.02.coefficient = summary.glm(rgmodel.02)[12]$coefficients[rgmodel.02.PvalueSort[1:65],]
knitr::kable(rgmodel.02.coefficient, digits = 4, format.args = list(scientific = TRUE), "simple")

# Observation to model 02:
# 1.Country Brazil,Hungary,India,Indonesia,Iran,Netherlands,New Zealand, Norway has NA coefficient
# 2.Except Japan and Greece has P-value around 0.2, other countries have P-value over 0.5
# 3. aspect_ratio appears to be very irrelevant
# 4. the reference selected by glm make data interpretation difficult 
#    (due to too many levels in languages and years)

# Improvement: remove irrelevant variables and reference the categorical variables
# To remove irrelevant variables
train.reg.02 = movie.regr.02[train.ind.02, -c(1,4,19)]
test.reg.02 = movie.regr.02[-train.ind.02, -c(1,4,19)]

# Specify reference levels for each categorical variables
train.reg.02$color = relevel(train.reg.02$color, ref = "Color")
train.reg.02$language = relevel(train.reg.02$language, ref = "English")
train.reg.02$content_rating = relevel(train.reg.02$content_rating, ref = "R")

# calculate sum of adj.gross for specifying movie.year reference
gros.ansum = aggregate(train.reg.02$adjust.gross, by = list(train.reg.02$movie.year), FUN = sum)
gros.ansum[order(gros.ansum$x, decreasing = T),] # 2009 is the most profitable year
train.reg.02$movie.year = relevel(train.reg.02$movie.year, ref = "2009")

# re-run logistic model to the subset of combined numeric & several categorical variables
rgmodel.02 = glm(adjust.gross ~ ., family = gaussian, data = train.reg.02)

# create an index of sorted Estimate/P-value, to list important variables on top
rgmodel.02.Rerun.PvalueSort = order(summary.glm(rgmodel.02)[12]$coefficients[,4], decreasing = FALSE)

#list logistic linear regression modeling statistics
summary.glm(rgmodel.02)[c(1,3:4)]
rgmodel.02.Rerun.coefficient = summary.glm(rgmodel.02)[12]$coefficients[rgmodel.02.Rerun.PvalueSort[1:47],]
knitr::kable(rgmodel.02.Rerun.coefficient, digits = 4, format.args = list(scientific = TRUE), "simple")



# Observation to 2nd round model 02:
# 1. Not enough data for language levels and movie.years
# 2. budget appears insignificant in this model
# 3. num_critic_for_reviews appears less significant
# not enough data records for language levels and movie years
# re-run logistic model to the subset of numeric data with "color" and "content_rating"
rgmodel.02mo = glm(adjust.gross ~ ., family = gaussian, data = train.reg.02[, -c(2,4,14,5)])
summary.glm(rgmodel.02mo)
pred.reg.02 <- predict(rgmodel.02mo, newdata = test.reg.02[, -c(2,4,14,5)], type = "response")

# visualize prediction vs actual data
png("plot_MovieMetaProfitPrediction.png")
par(mfrow = c(1,3))
par(mar = c(20, 5, 5, 2))
plot(adjgross.testreg01, pred.reg.01, type = "p", pch = 20, 
     xlim = c(0, 8e+8), ylim = c(0, 8e+8), las = 1, 
     xlab = "Inflation adjusted gross profit", 
     ylab = "Predicted gross profit", cex.axis = 0.8, cex.lab = 1.2)
title(main = "Prediction 1 vs Real gross profit \nprediction with numeric variables", 
      line = 1.5, adj = 0.6, cex.main = 1.2)
abline(a = 0, b= 1, col = "magenta", lty = 2, lwd = 3)
legend(5.5e+08, 8.5e+08, "y = x", xjust = 0.5, col = "magenta", 
       lty = 2, lwd = 3, bty = "n", x.intersp = 0.5, cex = 1.2)

plot(adjgross.testreg02, pred.reg.02, type = "p", pch = 20, 
     xlim = c(0, 8e+8), ylim = c(0, 8e+8), las = 1,
     xlab = "Inflation adjusted gross profit",
     ylab = "Predicted gross profit", cex.axis = 0.8, cex.lab = 1.2)
title(main = "Prediction 2 vs Real gross profit \nprediction with numeric variables,\ncolor and content rating",
      line = 1, adj = 0.6, cex.main = 1.2)
abline(a = 0, b= 1, col = "magenta", lty = 2, lwd = 3)
legend(5.5e+08, 8.5e+08, "y = x", xjust = 0.5, col = "magenta", 
       lty = 2, lwd = 3, bty = "n", x.intersp = 0.5, cex = 1.2)

# standard errors from two prediction
pred.error01 = pred.reg.01/adjgross.testreg01 - 1
pred.error02 = pred.reg.02/adjgross.testreg02 - 1

pred.erorlist = list(pred.error01, pred.error02)
bop01 = boxplot(pred.erorlist, range = 1.5, ylim = c(-4.5, 12), horizontal = F,
        axes = T,staplewex = 1, las = 1, par(mar = c(10, 4, 4, 1)),
        names = c("Prediction 1", "Prediction 2"), cex.lab = 1.2, cex.main = 1.2,
        main = "Prediction errors \n(percentage of over prediction)")
text(unique(bop01$group),  bop01$stats, pos = 1, offset = 0.4,
     labels = round(bop01$stats, 2), col = "blue", cex = 0.9, font = 2)
dev.off()
knitr::include_graphics(paste(working.path, "plot_MovieMetaProfitPrediction.png", sep = "/"))
                         

colnames(bop01$stats) = c("Prediction 1", "Prediction 2")
bop01$stats  # show the errors box plot statistics for both predictions


# visualize the relationship between individual predictors and movie gross profit
png("plot_MovieMetaData_ProfitContributors.png")
par(mfrow=c(2,3))
par(mar = c(4,4,4,2))
plot(test.reg.02$num_voted_users, adjgross.testreg02,
     xlim = c(0,1250000), ylim = c(0,1.5e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Number of voted users")
abline(lm(adjgross.testreg02 ~ test.reg.02$num_voted_users),
       col = "green", lwd = 3)

plot(test.reg.02$num_user_for_reviews, adjgross.testreg02,
     xlim = c(0,3000), ylim = c(0,1.5e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Number of reviewd users")
abline(lm(adjgross.testreg02 ~ test.reg.02$num_user_for_reviews),
       col = "green", lwd = 3)


plot(test.reg.02$cast_total_facebook_likes, adjgross.testreg02,
     xlim = c(0,110000), ylim = c(0,8e+08),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Total FB likes to movie casts")
abline(lm(adjgross.testreg02 ~ test.reg.02$cast_total_facebook_likes),
       col = "green", lwd = 3)


plot(test.reg.02$budget, adjgross.testreg02,
     xlim = c(0,4e+08), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Budget")
abline(lm(adjgross.testreg02 ~ test.reg.02$budget),
       col = "green", lwd = 3)


plot(test.reg.02$imdb_score, adjgross.testreg02,
     xlim = c(2,9), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "IMDB score")
abline(lm(adjgross.testreg02 ~ test.reg.02$imdb_score),
       col = "green", lwd = 3)


plot(movie.regr.02$content_rating, movie.regr.02$adjust.gross, 
     ylim = c(0,9e+08), 
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Content rating")
dev.off()
knitr::include_graphics(paste(working.path, "plot_MovieMetaData_ProfitContributors.png", sep = "/"))


png("plot_MovieMetaData_NotRealContributors.png")
par(mfrow = c(2,3))
par(mar = c(4,4,4,2))

plot(test.reg.02$duration, adjgross.testreg02,
     xlim = c(70,220), ylim = c(0,1.5e+09),
     las = 1, cex.axis = 0.75, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Movie duration")

plot(test.reg.02$movie_facebook_likes, adjgross.testreg02,
     xlim = c(0,90000), ylim = c(0,1.5e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "FB likes to movies")
abline(lm(adjgross.testreg02 ~ test.reg.02$movie_facebook_likes),
       col = "red", lwd = 3, lty = 3)

plot(test.reg.02$actor_1_facebook_likes, adjgross.testreg02,
     xlim = c(0,50000), ylim = c(0,1.5e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "FB likes to actor 1")
abline(lm(adjgross.testreg02 ~ test.reg.02$actor_1_facebook_likes),
       col = "red", lwd = 3, lty = 3)

plot(test.reg.02$actor_2_facebook_likes, adjgross.testreg02,
     xlim = c(0,30000), ylim = c(0,1.5e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "FB likes to actor 2")
abline(lm(adjgross.testreg02 ~ test.reg.02$actor_2_facebook_likes),
       col = "red", lwd = 3, lty = 3)

plot(test.reg.02$actor_3_facebook_likes, adjgross.testreg02,
    xlim = c(0,5000), ylim = c(0,1.5e+09),
    las = 1, cex.axis = 0.7, cex.lab = 1,
    ylab = "Inflation adjusted gross profit",
    xlab = "FB likes to actor 3")
abline(lm(adjgross.testreg02 ~ test.reg.02$actor_3_facebook_likes),
       col = "red", lwd = 3, lty = 3)

plot(movie.regr.02$color, movie.regr.02$adjust.gross,
     ylim = c(0,7e+08), las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit")
dev.off()
knitr::include_graphics(paste(working.path, "plot_MovieMetaData_NotRealContributors.png", sep = "/"))
                        

##############################################################################
#      Regression modeling, to explore the franchise movie financial data    #
##############################################################################

# check out the variables in the data set of franchise movie detail
names(fran.movie)
# leave out pre-clean, repeat, unsuitable (to regression) text-content variables
# and create a subset for regression modeling
franmovie.regrset= fran.movie[, -c(9, 15:16, 26)]
names(franmovie.regrset)
str(franmovie.regrset)

# create a vector indexing categorical variable of fran.regrest
fran.chrcol.index = c(1:2,7,9,12,15:17,23) # movie year should be character data

# use cleaned movie names as ID, move to the 1st left column
franmovie.regrset= data.frame(franmovie.regrset[,25], franmovie.regrset[,fran.chrcol.index], 
      franmovie.regrset[, -c(fran.chrcol.index,25)])
names(franmovie.regrset)[1] = "movie.names.clean"

# store franchise movie names in a vector
fran.movie.name = names(franmovie.regrset)
# coerce data types back and forward to change character "NA" to Null value
franmovie.regchr =  sapply(1: (1+length(fran.chrcol.index)), simplify = T, function(j){
                    as.character(as.factor(franmovie.regrset[, 1:10][,j]))})

franmovie.regnum = sapply(1:(dim(franmovie.regrset)[2]-1-length(fran.chrcol.index)), 
                    simplify = T, function(i){
                    as.numeric(as.character(franmovie.regrset[, 11:25][,i]))})

franmovie.regchr = data.frame(franmovie.regchr, stringsAsFactors = T)
franmovie.regnum = data.frame(franmovie.regnum, stringsAsFactors = F)
franmovie.regrset = cbind(franmovie.regchr, franmovie.regnum)
names(franmovie.regrset) = fran.movie.name
str(franmovie.regrset)
dim(franmovie.regrset)

# There are several hundreds of levels for directors and actors, 
# but the franchise movies data set does not have enough data points for so many levels
director_name.count = table(franmovie.regrset$director_name)[1:30]
actor_2_name.count = table(franmovie.regrset$actor_2_name)[1:30]
actor_1_name.count = table(franmovie.regrset$actor_1_name)[1:30]
actor_3_name.count = table(franmovie.regrset$actor_3_name)[1:30]

knitr::kable(director_name.count[-c(9)], col.names = c("Director's Name", "Frequency"), valign = 't') 
knitr::kable(actor_1_name.count[-c(28)], col.names = c("First Actor Name", "Frequency"), valign = 't')
knitr::kable(actor_2_name.count, col.names = c("Second Actor Name", "Frequency"), valign = 't')
knitr::kable(actor_3_name.count, col.names = c("Third Actor Name", "Frequency"), valign = 't')

# There are 7 to 52 levels for other categorical variables
# Values of color, language and country are dominated by "color", "English" and "USA"
regrset.color.count = table(franmovie.regrset$color)
regrset.lang.count = table(franmovie.regrset$language)
regrset.country.count =table(franmovie.regrset$country)
regrset.rating.count =table(franmovie.regrset$content_rating)
regrset.year.count =table(franmovie.regrset$movie.year)

knitr::kable(regrset.color.count, col.names = c("Color", "Count"), valign = 't') 
knitr::kable(regrset.lang.count, col.names = c("Language", "Count"), valign = 't') 
knitr::kable(regrset.country.count, col.names = c("Country", "Count"), valign = 't') 
knitr::kable(regrset.rating.count, col.names = c("Content Rating", "Count"), valign = 't')
knitr::kable(regrset.year.count[1:30,], col.names = c("Movie Years", "Count"), valign = 't') 


# create two subsets of franchise movies
# the first one only has numeric data, 
# the second one has numeric data with variables of color, language, country and content rating
franmovie.regr01 = franmovie.regrset[,-c(2:10)]
franmovie.regr02 = franmovie.regrset[,-c(3:6)]

# create matrix of NA value indices
# use non-repeat row number of the matrix to remove records with NA value
fran.narec.01 = which(is.na(franmovie.regr01) == T, arr.ind = T) 
franmovie.regr01 = franmovie.regr01[-unique(fran.narec.01[, "row"]), ]
fran.narec.02 = which(is.na(franmovie.regr02) == T, arr.ind = T)
franmovie.regr02  = franmovie.regr02[-unique(fran.narec.02[, "row"]), ]

# 4 records that NA values are only in the text-content variables
dim(franmovie.regr01)[1] - dim(franmovie.regr02)[1] 

# regression modeling
#create length variables for training data sets
library("stats")
set.seed(3456)
fran.train01.lgth = floor(0.6*dim(franmovie.regr01)[1])
fran.train02.lgth = floor(0.6*dim(franmovie.regr02)[1])

# generate random index with sample function to create training and test data sets
# exclude the movie names for both training and test data sets
fran.train01.ind = sample(1:dim(franmovie.regr01)[1], fran.train01.lgth)
fran.trn01.reg = franmovie.regr01[fran.train01.ind, -1]
fran.tst01.reg  = franmovie.regr01[-fran.train01.ind, -1]

fran.train02.ind = sample(1:dim(franmovie.regr02)[1], fran.train02.lgth)
fran.trn02.reg = franmovie.regr02[fran.train02.ind, -1]
fran.tst02.reg  = franmovie.regr02[-fran.train02.ind, -1]

#create a vector for storing the original value of adjust.gross variable
#adjust.gross is a dependent variable
fran.adjgross.tstreg01 = fran.tst01.reg$adjust.gross
fran.adjgross.tstreg02 = fran.tst02.reg$adjust.gross

#Then removed the existing variables for prediction
fran.tst01.reg$adjust.gross = NULL
fran.tst02.reg$adjust.gross = NULL

# run logistic model to the subset with only numeric variables only 
# adjust.gross is the dependent variable
# "." means include everything except the dependent variable
fran.model01 = glm(adjust.gross ~ ., family = gaussian, data = fran.trn01.reg)

# create an index of sorted Estimate/P-value, to list important variables on top
fran.model01.PvalueSort = order(summary.glm(fran.model01)[12]$coefficients[,4], decreasing = FALSE)

#list logistic linear regression modeling statistics
summary.glm(fran.model01)[c(1,3:4)]
fran.model01.coefficient = summary.glm(fran.model01)[12]$coefficients[fran.model01.PvalueSort,]
knitr::kable(fran.model01.coefficient, digits = 4, format.args = list(scientific = TRUE), "simple")


names(fran.trn01.reg)
#Observation to fran.model01
# movie_facebook_likes, aspect_ratio appears to be insignificant
# director_facebook_likes, facenumber_in_poster appears to be insignificant
# duration, num_user_for_reviews, imdb_score appears to be less significant
fran.model01mo = glm(adjust.gross ~ ., family = gaussian, data = fran.trn01.reg[,-c(2,3,8,9,12,13,14)])

# create an index of sorted Estimate/P-value, to list important variables on top
fran.model01mo.PvalueSort = order(summary.glm(fran.model01mo)[12]$coefficients[,4], decreasing = FALSE)

#list logistic linear regression modeling statistics
summary.glm(fran.model01mo)[c(1,3:4)]
fran.model01mo.coefficient = summary.glm(fran.model01mo)[12]$coefficients[fran.model01mo.PvalueSort,]
knitr::kable(fran.model01mo.coefficient, digits = 4, format.args = list(scientific = TRUE), "simple")

#predict response variable, the predicted values are probabilities
pred.fran.reg01 <- predict(fran.model01mo, newdata = fran.tst01.reg, type = "response")

# run logistic model to the subset of combined numeric & several categorical variables
fran.model02 = glm(adjust.gross ~ ., family = gaussian, data = fran.trn02.reg)
# create an index of sorted Estimate/P-value, to list important variables on top
fran.model02.PvalueSort = order(summary.glm(fran.model02)[12]$coefficients[,4], decreasing = FALSE)

#list logistic linear regression modeling statistics
summary.glm(fran.model02)[c(1,3:4)]
fran.model02.coefficient = summary.glm(fran.model02)[12]$coefficients[fran.model02.PvalueSort[1:35],]
knitr::kable(fran.model02.coefficient, digits = 4, format.args = list(scientific = TRUE), "simple")

# Observation:
# 1.Country Brazil,Denmark, Hongkong, Taiwan and Thailand has NA coefficient
# 2. Except Canada and USA has P-value less than 0.2, other countries have P-value no less than 0.4
# 3. Not enough data for language, country, movie years

# specify references for color and content_rating variables
fran.trn02.reg$color = relevel(fran.trn02.reg$color, ref = "Color")
table(fran.trn02.reg$content_rating)
fran.trn02.reg$content_rating = relevel(fran.trn02.reg$content_rating, ref = "R")

# remove variables: language, country, movie years
fran.model02 = glm(adjust.gross ~ ., family = gaussian, data = fran.trn02.reg[,-c(2:3,5)])
summary.glm(fran.model02)
pred.fran.reg02 <- predict(fran.model02, type = "response",
                           newdata = fran.tst02.reg[,-c(2:3,5)])

# Observation to 2nd round model02
# 1. num_user_for_reviews, num_critic_for_reviews, director_facebook_likes appear to be insignificant
# 2. duration director_facebook_likes, facenumber_in_poster appear to be insignificant
# 3. actor_3_facebook_likes, actor_2_facebook_likes appear to be less significant

fran.model02mo = glm(adjust.gross ~ ., family = gaussian, data = fran.trn02.reg[,-c(2:3,5:9,13:14,16)])
summary.glm(fran.model02mo)
pred.fran.reg02 <- predict(fran.model02mo, newdata = fran.tst02.reg[,-c(2:3,5:9,13:14,16)],
                           type = "response")

# visualize prediction vs actual data
png("plot_FranchiseMovieProfitPrediction.png")
par(mfrow = c(1,3))
par(mar = c(15, 4, 10, 3))
plot(pred.fran.reg01, fran.adjgross.tstreg01,  type = "p", pch = 20,
     xlim = c(0, 8e+8), ylim = c(0, 8e+8), las = 1,
     xlab = "Inflation adjusted gross profit", 
     ylab = "Predicted gross profit", cex.axis = 0.8, cex.lab = 1.2)
title(main = "Franchise profit Prediction 1 \nvs\n Real gross profit \nprediction with numeric variables", 
      line = 1.5, adj = 0.6, cex.main = 1.2)
abline(a = 0, b= 1, col = "magenta", lty = 2, lwd = 3)

plot(pred.fran.reg02, fran.adjgross.tstreg02,  type = "p", pch = 20,
     xlim = c(0, 8e+8), ylim = c(0, 8e+8), las = 1,
     xlab = "Inflation adjusted gross profit", 
     ylab = "Predicted gross profit", cex.axis = 0.8, cex.lab = 1.2)
title(main = "Franchise profit Prediction 2 \nvs\n Real gross profit \nprediction with numeric variables\ncolor and content rating", 
      line = 1.5, adj = 0.6, cex.main = 1.2)
abline(a = 0, b= 1, col = "magenta", lty = 2, lwd = 3)

# standard errors from two prediction of franchise movies
fran.pred.error01 = pred.fran.reg01/fran.adjgross.tstreg01 - 1
fran.pred.error02 = pred.fran.reg02/fran.adjgross.tstreg02 - 1

fran.pred.erorlist = list(fran.pred.error01, fran.pred.error02)
bop02 = boxplot(fran.pred.erorlist, range = 1.5, ylim = c(-2, 10),
                axes = T, staplewex = 1, las = 1, par(mar = c(10, 4, 4, 1.5)),
                names = c("Prediction 1", "Prediction 2"), 
                cex.lab = 1.2, cex.main = 1.2, 
                main = "Franchis prediction errors \n(percentage of over prediction)")
text(unique(bop02$group),  bop02$stats, pos = 1, offset = 0.4,
     labels = round(bop02$stats, 2), col = "blue", cex = 0.9, font = 2)
dev.off()
knitr::include_graphics(paste(working.path, "plot_FranchiseMovieProfitPrediction.png", sep = "/"),
                         auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))


colnames(bop02$stats) = c("Franchise prediction 1", "Franchise prediction 2")
bop02$stats  # show the errors box plot statistics for both predictions


# visualize the relationship between individual predictors and movie gross profit
png("plot_FranchiseMovie_ProfitContributors.png")
par(mfrow=c(2,3))
par(mar = c(4,4,3,2))

plot(fran.tst02.reg$num_voted_users, fran.adjgross.tstreg02,
     xlim = c(0,1200000), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Number of voted users")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$num_voted_users),
       col = "yellow green", lwd = 3)

plot(fran.tst02.reg$num_user_for_reviews, fran.adjgross.tstreg02,
     xlim = c(0,3600), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Number of users for reviews")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$num_user_for_reviews),
       col = "yellow green", lwd = 3)

plot(fran.tst02.reg$num_critic_for_reviews, fran.adjgross.tstreg02,
     xlim = c(0,800), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Number of critic reviews")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$num_critic_for_reviews),
       col = "yellow green", lwd = 3)

plot(fran.tst02.reg$budget, fran.adjgross.tstreg02,
     xlim = c(0,3e+08), ylim = c(0,8e+08),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Budget")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$budget),
       col = "yellow green", lwd = 3)

plot(fran.tst02.reg$imdb_score, fran.adjgross.tstreg02,
     xlim = c(2,9), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "IMDB score")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$imdb_score),
       col = "yellow green", lwd = 3)

plot(franmovie.regr02$content_rating, franmovie.regr02$adjust.gross,
     xlim = c(0,10), ylim = c(0,8.5e+08),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Content rating")
dev.off()
knitr::include_graphics(paste(working.path, "plot_FranchiseMovie_ProfitContributors.png", sep = "/"),
                         auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))


png("plot_FranchiseMovie_NotRealContributors.png")
par(mfrow=c(2,3))
par(mar = c(4,4,4,2))

plot(fran.tst02.reg$director_facebook_likes, fran.adjgross.tstreg02,
     xlim = c(0,1000), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "FB likes to directors")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$director_facebook_likes),
       col = "orange red", lwd = 3, lty = 3)

plot(fran.tst02.reg$cast_total_facebook_likes, fran.adjgross.tstreg02,
     xlim = c(0,60000), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Total FB likes to cast")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$cast_total_facebook_likes),
       col = "orange red", lwd = 3, lty = 3)

plot(fran.tst02.reg$facenumber_in_poster, fran.adjgross.tstreg02,
     xlim = c(0,10), ylim = c(0,1e+09),
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Face number in posters")
abline(lm(fran.adjgross.tstreg02 ~ fran.tst02.reg$facenumber_in_poster),
       col = "orange red", lwd = 3, lty = 3)

plot(franmovie.regr02$movie.year, franmovie.regr02$adjust.gross,
     ylim = c(0,1.9e+09), 
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Movie years")

plot(franmovie.regr02$color, franmovie.regr02$adjust.gross,
     ylim = c(0,1.2e+09), 
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Color")

plot(fran.tst02.reg$language, fran.adjgross.tstreg02,
     ylim = c(0,5e+08), 
     las = 1, cex.axis = 0.7, cex.lab = 1,
     ylab = "Inflation adjusted gross profit",
     xlab = "Language")

dev.off()
knitr::include_graphics(paste(working.path, "plot_FranchiseMovie_NotRealContributors.png", sep = "/"),
                         auto_pdf = getOption("knitr.graphics.auto_pdf", TRUE))


knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

